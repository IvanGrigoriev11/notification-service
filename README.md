# Сервис уведомлений

REST api сервис уведомления пользователей, который позволяет создавать запись уведомления в документе пользователя в MongoDB, отправлять email, а так же предоставлять листинг уведомлений из документа пользователя.

## Установка

1. Установить poetry: [Poetry](https://python-poetry.org/).
1. Установить pyenv: [PyEnv](https://github.com/pyenv/pyenv).
1. Установить python версией 3.11: `pyenv install 3.11`.
1. Открыть терминал и проследовать в корневую папку склонированного проекта: `cd <repo root>`.
1. Создать и активировать python virtualenv: `poetry shell`.
1. Установить зависимости проекта: `poetry install`.

## Установка конфигурации для запуска MongoDB и SMTP сервера локально
1. `open ~/.zshrc`.
1. Выставите переменные окружения со следующими значениями:
    1. `DB_URI='mongodb://admin:pass@mongo:27017'`
    1. `SMTP_HOST='smtp'`
    1. `SMTP_PORT=2500`
    1. `SMTP_LOGIN='login'`
    1. `SMTP_PASSWORD='password'`
    1. `SMTP_EMAIL='foo@mail.ru'`
    1. `SMTP_NAME='name'`
    1. `MONGO_INITDB_ROOT_USERNAME='admin'`
    1. `MONGO_INITDB_ROOT_PASSWORD='pass'`
    1. `MONGO_INITDB_DATABASE='mydatabase'`
1. `source ~/.zshrc`.

## Сборка docker образов

### Сборка docker образов автоматически
1. Для пулла всех необходимых образов и сборки docker обраа сервиса уведомлений надо в корневой папке проекта запустить скрипт: `./docker-build.sh`.

### Развертывание docker образов вручную
1. В корневой папке проекта запустить: `docker build --tag notification-service .`.
1. Спуллить соответствующие образы MongoDB `docker pull mongo` и SMTP сервиса `docker pull marcopas/docker-mailslurper`.

## Запуск docker образов

1. В корневой папке проекта запустить: `docker-compose up -d`.

## Взаимодействие с сервисом

### Вручную
1. Доступ к API можно получить через интерактивную swagger UI документацию: `http://127.0.0.1:8000/docs` или при помощи request запросов в Postman.

### Автоматически
1. Реализуется через системное тестирование (см. секцию `тестирование -> системное тестирование`).

## Тестирование

### Системное тестирование
1. Для запуска нужно в корневой папке директории запустить скрипт: `./run_tests.sh`, который перед развертыванием инфраструктуры запускает unit тесты. Скрипт развернет всю необходимую docker инфраструктуру и после завершения уберет запущенные образы.

### Unit и интеграционные тесты
1. Для запуска используется команда `pytest tests/test_units.py` в корневой папке проекта.
